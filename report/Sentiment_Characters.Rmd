---
output:
  html_document: default
  pdf_document: default
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
source("../scripts/setup.R")
```

## Sentiment Analysis by Characters 
After the analysis of the script according to the seasons, we wanted to see how the five main characters (Sheldon, Leonard, Penny, Raj and Howard) of the show impact the script of the show through a sentiment analysis. 

We use a data set with which an observation is given for a character according to the sentence he says.  Thus, we can use again here the 'nrc' lexicon and have an idea of the dispersions of the feelings for each of our characters.
# (Should we do the graph with the agg_tbl ?)

```{r}
char.tb <- as_tibble(data.frame(character_speech))

char.tk <- unnest_tokens(
  char.tb,
  output = "word",
  input = "character_scripts",
  to_lower = TRUE,
  strip_punct = TRUE,
  strip_numeric = TRUE)
 
char.tk <- char.tk %>%
  anti_join(stop_words, by = c("word" = "word"))
  
char.sent <- 
  inner_join(
    char.tk,
    get_sentiments("nrc"),
    by = c("word" = "word"))

head(char.sent, 10) %>% 
  flextable() %>%
  autofit()

```

```{r}
## Long format
char.sent %>% 
  group_by(character_name, sentiment) %>% 
  summarize(n = n()) %>%
  ungroup() %>% 
  ggplot(aes(x = sentiment,
             y = n,
             fill = sentiment)) + 
  geom_bar(stat = "identity",
           alpha = 0.8) + 
  facet_wrap(~character_name) + 
  coord_flip()
```

```{r echo=FALSE}
char.dfm %>% textstat_lexdiv()

char.dfm %>% textstat_lexdiv() %>%
  arrange(desc(TTR)) %>%
  slice(1:10) %>% #plot only the top 10
  ggplot(aes(reorder(document, -TTR),
             TTR)) + 
  geom_bar(stat = "identity") + 
  xlab("character_name") + 
  ggtitle("Plot of the 10 top Token-Type-Ratio") 
```

## Negative-Positive Ratio in all seasons by using bing lexicon
```{r echo=FALSE, include=FALSE}
head(get_sentiments(lexicon = "bing"))
```

```{r}
char.sent2 <-
  inner_join(
    char.tk, 
    get_sentiments("bing"),
    by = c("word" = "word"))

char.sent2 %>% 
  group_by(character_name) %>% 
  group_by(season, character_name) %>% 
  count(sentiment) %>%
  ungroup() %>%
  ggplot(aes(season, n, fill = sentiment)) +
  geom_col(position = "fill") +
  geom_text(aes(label = n), position = position_fill(0.5), color = "white")+
  coord_flip()+
  facet_wrap(character_name~.)+
  theme_dark()+
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold")
    )+
  scale_fill_manual(values = c("#EA181E", "chartreuse3"))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10))+
  labs(y = NULL,  x = "Season", fill = NULL, title = "Negative-Positive Ratio in all seasons by using bing lexicon")
```

```{r}
char.sent2 %>% 
  group_by(season) %>% 
  mutate(seq = row_number()) %>% 
  ungroup() %>% 
  unnest_tokens(word, main_character_script) %>% 
  anti_join(stop_words) %>% 
  filter(!word %in% tolower(character_name)) %>% 
  inner_join(get_sentiments(lexicon = "bing")) %>% 
  count(season, index = seq %/% 50, sentiment) %>% 
  spread(sentiment, n, fill = 0) %>%
  mutate(sentiment = positive - negative) %>% 
  ggplot(aes(index, sentiment, fill = factor(season))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(paste0("Season ",season)~., ncol = 2, scales = "free_x")+
  theme_dark()+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"))+
  labs(x = "Index", y = "Sentiment", title = "Negative-Positive Distribution in all seasons by using afinn lexicon")
```

# Valence shifter approach on each character 
```{r echo=FALSE, include=FALSE}
character.speech.text <- get_sentences(agg_tbl)
character.speech.senti <- sentiment(character.speech.text) 
```

```{r echo=FALSE}
character.speech.senti %>% group_by(character_name) %>% 
  ggplot(aes(x = sentence_id, y = sentiment)) + 
  geom_line() +  
  facet_wrap(~ character_name, scale="free_x")

```
The analysis is possible by going through each sentence. The most 'instense' character is Sheldon, he appears to be very expressive in the positive like in the negative. However we can guess that he tends to be less and less negative through the end of the show. The lowest peaks are a little bit less frequent. 

```{r echo=FALSE, include=FALSE}
sentiment_by(character.speech.senti)
```

```{r echo=FALSE}
docnames(char.cp) <- c('Howard', 'Leonard', 'Penny', 'Raj', 'Sheldon')

sentiment_by(character.speech.senti) %>% 
  mutate(characters_names = docnames(char.cp)) %>%
  ggplot(aes(x = reorder(characters_names, ave_sentiment),
             y = ave_sentiment)) + 
  ylab("Avg sentiment") +
  geom_bar(stat = "identity") + 
  coord_flip() + 
  xlab("") 
```
With this barplot, we can once again identify the average sentiment and see that the most positive character is Penny with an average of 0.13, followed by Leonard. The least positive character is Sheldon.
